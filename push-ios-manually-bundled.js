#!/usr/bin/env node

// push from bundle generated by ./bundle.sh

const proc = require('child_process')
const fs = require('fs')
const build = fs.readFileSync('./iOS/Tradle/Info.plist', { encoding: 'utf8' })
const match = build.match(/CFBundleVersion<\/key>\n\s+<string>([\d\.]+)/)
const fourPartVersion = match[1]
const threePartVersion = fourPartVersion.split('.').slice(0, 3).join('.')
if (!threePartVersion) throw new Error('unable to parse version from Dev.plist')

const gitHash = require('./version').commit.slice(0, 6)
const releases = fs.readdirSync(`./release/ios/${fourPartVersion}`)
const releaseDirname = releases.find(r => r.indexOf(gitHash) === 0)
if (!releaseDirname) throw new Error('release dir not found, run bundle.sh first')

const releaseDir = `./release/ios/${fourPartVersion}/${releaseDirname}/`
const pushLine = `code-push release tim-ios ${releaseDir} ${threePartVersion} -d Staging`
console.log(`running: ${pushLine}`)

if (process.argv.indexOf('--dry-run') === -1) {
  proc.execSync(pushLine, {
    cwd: process.cwd(),
    env: process.env,
    stdio: 'inherit'
  })
}
